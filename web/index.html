<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Go Real-Time Stream</title>
<style>
  body { background:#000; color:#0f0; font-family: monospace; }
  #hr { font-size: 28px; margin-bottom: 10px; }
  canvas { background:#111; }
  .row { display:flex; gap:16px; align-items:center; }
  .small { color:#7f7; font-size: 12px; }
</style>
</head>
<body>

<div class="row">
  <div id="hr">HR: --</div>
  <div class="small">
    Waves: binary Float32Array · Params: JSON ·
    <a href="/metrics" style="color:#7f7">/metrics</a>
  </div>
</div>

<canvas id="wave" width="900" height="250"></canvas>

<script>
const ws = new WebSocket("ws://" + location.host + "/ws");
ws.binaryType = "arraybuffer";

const canvas = document.getElementById("wave");
const ctx = canvas.getContext("2d");

const PX_PER_SAMPLE = 2;   // baja a 1 si querés más “lento”
const SCALE_Y = 80;

let writeX = 0;
let lastY = canvas.height / 2;

ctx.strokeStyle = "#0f0";

ws.onmessage = (event) => {

  // 1) Binary wave batch (Float32 LE)
  if (event.data instanceof ArrayBuffer) {
    const samples = new Float32Array(event.data);

    for (let i = 0; i < samples.length; i++) {
      const v = samples[i];
      const y = canvas.height/2 - v * SCALE_Y;

      ctx.beginPath();
      ctx.moveTo(writeX, lastY);
      ctx.lineTo(writeX + PX_PER_SAMPLE, y);
      ctx.stroke();

      lastY = y;
      writeX += PX_PER_SAMPLE;

      if (writeX >= canvas.width) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        writeX = 0;
      }
    }
    return;
  }

  // 2) Text params (JSON)
  try {
    const data = JSON.parse(event.data);
    if (data.hr) {
      document.getElementById("hr").innerText = "HR: " + data.hr + " BPM";
    }
  } catch (e) {
    // ignore
  }
};
</script>

</body>
</html>
